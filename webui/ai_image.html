<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #f97316;
            --sidebar-bg: #fafafa;
            --main-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --hover-bg: #f3f4f6;
            --code-bg: #f9fafb;
            --button-hover: #f3f4f6;
        }

        body.dark-mode {
            --sidebar-bg: #171717;
            --main-bg: #0a0a0a;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            --border-color: #262626;
            --hover-bg: #1c1c1c;
            --code-bg: #171717;
            --button-hover: #262626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--main-bg);
            height: 100vh;
            display: flex;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .sidebar-header {
            padding: 16px;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .app-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .new-chat-btn:hover {
            background: var(--hover-bg);
        }

        .sidebar-section {
            padding: 0 16px;
            margin-top: 12px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px 16px;
        }

        .history-item {
            padding: 8px 12px;
            margin-bottom: 2px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item:hover {
            background: var(--hover-bg);
        }

        .history-item.active {
            background: var(--primary-color);
            color: white;
        }

        .history-item-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .delete-btn {
            opacity: 0;
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }

        .history-item:hover .delete-btn {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .model-selector {
            padding: 6px 12px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--hover-bg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: var(--main-bg);
        }

        .message-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .message.user .message-avatar {
            background: var(--primary-color);
            color: white;
        }

        .message.assistant .message-avatar {
            background: #e5e7eb;
            color: var(--text-primary);
        }

        .message-content {
            flex: 1;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-image {
            max-width: 100%;
            border-radius: 12px;
            margin: 16px 0;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.01);
        }

        /* Code Blocks */
        .code-block-wrapper {
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .code-header {
            background: var(--code-bg);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .code-language {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .code-action-btn:hover {
            background: var(--button-hover);
            color: var(--text-primary);
        }

        .code-action-btn.copied {
            color: var(--primary-color);
        }

        .message-content pre {
            background: var(--code-bg);
            padding: 16px;
            overflow-x: auto;
            margin: 0;
            border-radius: 0 0 8px 8px;
            transition: all 0.3s ease;
        }

        .code-pre {
            background: var(--code-bg);
            padding: 16px;
            overflow-x: auto;
            margin: 0;
            border-radius: 0 0 8px 8px;
            transition: all 0.3s ease;
        }

        .message-content code {
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            color: var(--text-primary);
        }

        .loading {
            display: inline-flex;
            gap: 4px;
            padding: 4px 0;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Streaming cursor */
        .cursor {
            display: inline-block;
            width: 2px;
            background: var(--text-primary);
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Input Area */
        .input-container {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .attachment-preview {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .attachment-item {
            position: relative;
            padding: 8px 12px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .attachment-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .attachment-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 6px;
            font-size: 16px;
            border-radius: 4px;
        }

        .attachment-remove:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .chat-input {
            width: 100%;
            min-height: 52px;
            max-height: 200px;
            padding: 14px 100px 14px 16px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 4px;
        }

        .input-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .input-btn:hover {
            background: var(--button-hover);
        }

        .send-button {
            background: var(--primary-color);
            color: white;
        }

        .send-button:hover:not(:disabled) {
            background: #ea580c;
        }

        .send-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 48px 24px;
            text-align: center;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            background: var(--code-bg);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 24px;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            max-width: 800px;
            width: 100%;
        }

        .example-card {
            padding: 16px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .example-card:hover {
            background: var(--hover-bg);
            border-color: var(--primary-color);
        }

        .example-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .example-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .example-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="app-title">
                <div class="app-icon">ü§ñ</div>
                <span>AI Assistant</span>
            </div>
            <button class="new-chat-btn" onclick="newChat()">
                <span>‚úèÔ∏è</span>
                <span>New Chat</span>
            </button>
        </div>

        <div class="sidebar-section">
            <div class="section-title">Today</div>
        </div>

        <div class="chat-history" id="chatHistory">
        </div>

        <div class="sidebar-footer">
            <div class="user-avatar">U</div>
            <div class="user-info">
                <div class="user-name">User</div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <div class="model-selector">
                <span>ü§ñ</span>
                <span>AI Assistant</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme" id="themeBtn">üåô</button>
            </div>
        </div>

        <div class="chat-messages" id="messages">
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <div class="attachment-preview" id="attachmentPreview"></div>
                <textarea 
                    id="userInput" 
                    class="chat-input" 
                    placeholder="Send a message..."
                    rows="1"
                ></textarea>
                <div class="input-actions">
                    <input type="file" id="fileInput" accept="image/*,.pdf,.txt,.doc,.docx" style="display: none;" onchange="handleFileSelect(event)">
                    <button class="input-btn" title="Attach File" onclick="document.getElementById('fileInput').click()">üìé</button>
                    <button id="sendBtn" class="input-btn send-button" onclick="sendMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHistoryDiv = document.getElementById('chatHistory');

        const N8N_WEBHOOK_URL = 'http://192.168.50.202:5678/webhook/db604b2c-9149-41f1-bcc1-b1a5f38a1f3b/chat';

        let currentChatId = generateChatId();
        let chatHistory = {};
        let hasMessages = false;
        let conversationHistory = [];
        let attachedFiles = []; // Store attached files

        function initializeApp() {
            chatHistory = loadChatHistory();
            showEmptyState();
            loadTheme();
        }

        // Handle file selection
        function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result // Base64 data
                    };
                    
                    attachedFiles.push(fileData);
                    updateAttachmentPreview();
                };

                reader.readAsDataURL(file);
            });

            // Reset file input
            event.target.value = '';
        }

        // Update attachment preview
        function updateAttachmentPreview() {
            const preview = document.getElementById('attachmentPreview');
            if (!preview) return;

            if (attachedFiles.length === 0) {
                preview.innerHTML = '';
                return;
            }

            preview.innerHTML = attachedFiles.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const icon = isImage ? `<img src="${file.data}" alt="${file.name}">` : 'üìÑ';
                const sizeKB = (file.size / 1024).toFixed(1);

                return `<div class="attachment-item">
                    ${isImage ? icon : '<span style="font-size: 24px;">üìÑ</span>'}
                    <span class="attachment-name" title="${file.name}">${file.name}</span>
                    <span style="color: var(--text-muted); font-size: 11px;">${sizeKB}KB</span>
                    <button class="attachment-remove" onclick="removeAttachment(${index})" title="Remove">‚úï</button>
                </div>`;
            }).join('');
        }

        // Remove attachment
        function removeAttachment(index) {
            attachedFiles.splice(index, 1);
            updateAttachmentPreview();
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeBtn = document.getElementById('themeBtn');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeBtn.textContent = '‚òÄÔ∏è';
            } else {
                themeBtn.textContent = 'üåô';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.getElementById('themeBtn');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                themeBtn.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeBtn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }

        initializeApp();

        function showEmptyState() {
            messagesDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üé®</div>
                    <h2>Welcome to AI Assistant</h2>
                    <p>Start a conversation or try one of these examples</p>
                    <div class="example-prompts">
                        <div class="example-card" onclick="insertExample('generate image of RST logo')">
                            <div class="example-icon">üé®</div>
                            <div class="example-title">Generate Logo</div>
                            <div class="example-text">Create professional logo designs</div>
                        </div>
                        <div class="example-card" onclick="insertExample('generate image of cute cat')">
                            <div class="example-icon">üñºÔ∏è</div>
                            <div class="example-title">Create Image</div>
                            <div class="example-text">Generate images from descriptions</div>
                        </div>
                        <div class="example-card" onclick="insertExample('What is artificial intelligence?')">
                            <div class="example-icon">üí¨</div>
                            <div class="example-title">Ask Questions</div>
                            <div class="example-text">Get answers to any question</div>
                        </div>
                        <div class="example-card" onclick="insertExample('generate image of cartoon dog')">
                            <div class="example-icon">üé≠</div>
                            <div class="example-title">Cartoon Style</div>
                            <div class="example-text">Create cartoon illustrations</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function loadChatHistory() {
            const history = localStorage.getItem('chatHistory');
            const parsed = history ? JSON.parse(history) : {};
            updateHistorySidebar();
            return parsed;
        }

        function saveChatHistory() {
            try {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                updateHistorySidebar();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn('localStorage quota exceeded, cleaning old chats...');
                    // Keep only last 10 chats
                    const chats = Object.values(chatHistory).sort((a, b) => b.timestamp - a.timestamp);
                    chatHistory = {};
                    chats.slice(0, 10).forEach(chat => {
                        chatHistory[chat.id] = chat;
                    });
                    try {
                        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                        updateHistorySidebar();
                    } catch (e2) {
                        console.error('Still too large, clearing all history');
                        chatHistory = {};
                        localStorage.removeItem('chatHistory');
                    }
                }
            }
        }

        function saveCurrentChat() {
            if (!hasMessages) return;

            const messages = Array.from(messagesDiv.querySelectorAll('.message')).map(msg => ({
                type: msg.classList.contains('user') ? 'user' : 'assistant',
                content: msg.querySelector('.message-content').innerHTML
            }));

            if (messages.length > 0) {
                chatHistory[currentChatId] = {
                    id: currentChatId,
                    messages: messages,
                    timestamp: Date.now(),
                    title: extractChatTitle(messages)
                };
                saveChatHistory();
            }
        }

        function extractChatTitle(messages) {
            const firstUserMsg = messages.find(m => m.type === 'user');
            if (firstUserMsg) {
                const text = firstUserMsg.content.replace(/<[^>]*>/g, '');
                return text.substring(0, 30) + (text.length > 30 ? '...' : '');
            }
            return 'New Chat';
        }

        function updateHistorySidebar() {
            const chats = Object.values(chatHistory).sort((a, b) => b.timestamp - a.timestamp);
            
            if (chats.length === 0) {
                chatHistoryDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 13px;">No conversations yet</div>';
            } else {
                chatHistoryDiv.innerHTML = chats.map(chat => `
                    <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                        <span class="history-item-text">üí¨ ${chat.title}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        function newChat() {
            saveCurrentChat();
            currentChatId = generateChatId();
            hasMessages = false;
            conversationHistory = [];
            showEmptyState();
            updateHistorySidebar();
            userInput.focus();
        }

        function loadChat(chatId) {
            saveCurrentChat();
            
            const chat = chatHistory[chatId];
            if (chat) {
                currentChatId = chatId;
                hasMessages = true;
                conversationHistory = [];
                messagesDiv.innerHTML = '<div class="message-wrapper" id="messageWrapper"></div>';
                const wrapper = document.getElementById('messageWrapper');
                
                chat.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.type}`;
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    avatar.textContent = msg.type === 'user' ? 'U' : 'AI';
                    
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.innerHTML = msg.content;
                    
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(content);
                    wrapper.appendChild(messageDiv);

                    if (conversationHistory.length < 6) {
                        conversationHistory.push({
                            role: msg.type === 'user' ? 'user' : 'assistant',
                            content: msg.content.replace(/<[^>]*>/g, '')
                        });
                    }
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                updateHistorySidebar();
            }
        }

        function deleteChat(chatId) {
            if (confirm('Delete this conversation?')) {
                delete chatHistory[chatId];
                saveChatHistory();
                if (chatId === currentChatId) {
                    newChat();
                }
            }
        }

        setInterval(() => {
            saveCurrentChat();
        }, 30000);

        window.addEventListener('beforeunload', () => {
            saveCurrentChat();
        });

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function insertExample(text) {
            userInput.value = text;
            userInput.focus();
        }

        function formatCodeBlocks(text) {
            // Match code blocks: ```language\ncode```
            const codeBlockPattern = /```(\w+)?\n([\s\S]*?)```/g;
            let matches = [];
            let match;
            
            // Find all code blocks
            while ((match = codeBlockPattern.exec(text)) !== null) {
                matches.push({
                    fullMatch: match[0],
                    language: match[1] || 'code',
                    code: match[2]
                });
            }
            
            // Replace each code block
            matches.forEach((m, index) => {
                const language = m.language;
                const code = m.code.trim();
                
                // Escape HTML
                const escapedCode = code
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Generate unique IDs
                const blockId = 'block_' + Date.now() + '_' + index;
                const codeId = 'code_' + Date.now() + '_' + index;
                
                // Create HTML for code block
                const codeBlockHtml = `<div class="code-block-wrapper" id="${blockId}">
                    <div class="code-header">
                        <span class="code-language">${language.toUpperCase()}</span>
                        <div class="code-actions">
                            <button class="code-action-btn" onclick="toggleCodeBlock('${blockId}')">Collapse</button>
                            <button class="code-action-btn" onclick="copyCodeBlock('${codeId}', this)">Copy</button>
                        </div>
                    </div>
                    <pre id="${codeId}"><code>${escapedCode}</code></pre>
                </div>`;
                
                // Replace in text
                text = text.replace(m.fullMatch, codeBlockHtml);
            });
            
            return text;
        }

        // Copy code block
        function copyCodeBlock(codeId, button) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) {
                console.error('Code element not found:', codeId);
                button.textContent = '‚úó Not Found';
                setTimeout(() => button.textContent = 'Copy', 2000);
                return;
            }
            
            const code = codeElement.textContent;
            
            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(code).then(() => {
                    button.textContent = '‚úì Copied';
                    button.classList.add('copied');
                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopy(code, button);
                });
            } else {
                // Fallback for HTTP or older browsers
                fallbackCopy(code, button);
            }
        }

        // Fallback copy method (works on HTTP)
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.top = '-9999px';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            try {
                textarea.select();
                textarea.setSelectionRange(0, text.length);
                const successful = document.execCommand('copy');
                
                if (successful) {
                    button.textContent = '‚úì Copied';
                    button.classList.add('copied');
                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.classList.remove('copied');
                    }, 2000);
                } else {
                    button.textContent = '‚úó Failed';
                    setTimeout(() => button.textContent = 'Copy', 2000);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                button.textContent = '‚úó Failed';
                setTimeout(() => button.textContent = 'Copy', 2000);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Toggle code block collapse
        function toggleCodeBlock(blockId) {
            const block = document.getElementById(blockId);
            if (!block) {
                console.error('Block not found:', blockId);
                return;
            }
            
            const pre = block.querySelector('pre');
            const button = block.querySelector('.code-action-btn:first-child');
            
            if (!pre || !button) {
                console.error('Pre or button not found');
                return;
            }
            
            if (pre.style.display === 'none') {
                pre.style.display = 'block';
                button.textContent = 'Collapse';
            } else {
                pre.style.display = 'none';
                button.textContent = 'Expand';
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message && attachedFiles.length === 0) return;

            if (!hasMessages) {
                messagesDiv.innerHTML = '<div class="message-wrapper" id="messageWrapper"></div>';
                hasMessages = true;
            }

            const wrapper = document.getElementById('messageWrapper') || messagesDiv;

            userInput.disabled = true;
            sendBtn.disabled = true;

            // Build user message with thumbnails
            let userMessageHtml = message || 'Image';
            
            // Add image thumbnails to user message
            attachedFiles.forEach(file => {
                if (file.type.startsWith('image/')) {
                    userMessageHtml += `<br><img src="${file.data}" alt="${file.name}" class="message-image" style="max-width: 300px; margin-top: 8px; cursor: pointer;" onclick="window.open('${file.data}', '_blank')" />`;
                }
            });

            // Add user message
            addMessage(userMessageHtml, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';

            conversationHistory.push({ role: 'user', content: message });
            if (conversationHistory.length > 6) {
                conversationHistory = conversationHistory.slice(-6);
            }

            // Show loading
            const loadingId = addMessage(`
                <div class="loading">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `, 'assistant', true);

            try {
                // Debug: Log what we're sending
                console.log('üì§ Sending to n8n:', {
                    message: message,
                    attachmentCount: attachedFiles.length,
                    attachments: attachedFiles.map(f => ({
                        name: f.name,
                        type: f.type,
                        size: f.size,
                        hasData: !!f.data,
                        dataLength: f.data ? f.data.length : 0
                    }))
                });
                
                if (attachedFiles.length > 0) {
                    console.log('Full attachment data preview:', {
                        name: attachedFiles[0].name,
                        type: attachedFiles[0].type,
                        dataStart: attachedFiles[0].data.substring(0, 50) + '...'
                    });
                }

                // IMPORTANT: Send the exact structure
                const payload = { 
                    chatInput: message,
                    conversationHistory: conversationHistory,
                    attachments: attachedFiles
                };
                
                console.log('üîç Payload structure:', {
                    hasChatInput: !!payload.chatInput,
                    hasHistory: !!payload.conversationHistory,
                    hasAttachments: !!payload.attachments,
                    attachmentCount: payload.attachments ? payload.attachments.length : 0
                });

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Clear attachments after sending
                attachedFiles = [];
                updateAttachmentPreview();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const rawText = await response.text();
                let responseText = '';
                
                if (rawText.includes('"type":"item"') && rawText.includes('"content":"')) {
                    const contentMatch = rawText.match(/"content":"((?:[^"\\]|\\.)*)"/);
                    if (contentMatch && contentMatch[1]) {
                        responseText = contentMatch[1];
                        responseText = responseText.replace(/\\n/g, '\n');
                        responseText = responseText.replace(/\\"/g, '"');
                        responseText = responseText.replace(/\\\\/g, '\\');
                    }
                } else {
                    try {
                        const data = JSON.parse(rawText);
                        responseText = data.output || data.text || data.response || data.message || data.content || JSON.stringify(data);
                    } catch (jsonError) {
                        responseText = rawText || 'No response received';
                    }
                }
                
                // Format response
                responseText = formatCodeBlocks(responseText);
                responseText = responseText.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, 
                    '<img src="$2" alt="$1" class="message-image" onclick="window.open(\'$2\', \'_blank\')" />');
                responseText = responseText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '');
                responseText = responseText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                const parts = responseText.split(/(<div class="code-block-wrapper">[\s\S]*?<\/div>|<img[^>]*>)/);
                responseText = parts.map((part) => {
                    if (part.includes('code-block-wrapper') || part.startsWith('<img')) {
                        return part;
                    }
                    return part.replace(/\n/g, '<br>');
                }).join('');
                
                // Show response instantly (no fake typing)
                updateMessage(loadingId, responseText);

                // Filter out fake image generation responses from conversation history
                const cleanResponse = responseText.replace(/<[^>]*>/g, '');
                const isFakeGeneration = cleanResponse.includes('Image Generated Successfully') && 
                                        !cleanResponse.includes('![Generated Image]');
                
                // Only add to history if it's NOT a fake generation
                if (!isFakeGeneration) {
                    conversationHistory.push({ 
                        role: 'assistant', 
                        content: cleanResponse
                    });
                    if (conversationHistory.length > 6) {
                        conversationHistory = conversationHistory.slice(-6);
                    }
                }
                
                saveCurrentChat();
                
            } catch (error) {
                console.error('Error:', error);
                updateMessage(loadingId, `‚ùå Error: ${error.message}`);
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        function addMessage(content, type, returnId = false) {
            const wrapper = document.getElementById('messageWrapper') || messagesDiv;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'U' : 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            wrapper.appendChild(messageDiv);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (returnId) {
                return messageDiv;
            }
        }

        function updateMessage(messageElement, newContent) {
            const contentDiv = messageElement.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = newContent;
            }
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>